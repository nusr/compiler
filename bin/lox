#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const readline = require('readline');
const loxData = require('../lib/lox.umd');
process.env.DEBUG = '*';
const { Lox, defaultErrorHandler, Environment } = loxData;

const lox = new Lox();
function init() {
  const args = process.argv;
  console.log(args);
  if (args.length > 3) {
    console.log('Usage: lox [filepath]]');
    process.exit(64);
  } else if (args.length === 3 && args[2]) {
    runFile(args[2]);
  } else {
    runPrompt();
  }
}

function runFile(filePath) {
  const temp = path.resolve(process.cwd(), filePath);
  fs.readFile(temp, 'utf-8', (error, data) => {
    if (error) {
      defaultErrorHandler.error(0, error.stack || error.message);
      return;
    }
    new Lox().run(data, new Environment(null));
    if (defaultErrorHandler.get()) {
      process.exit(65);
    }
  });
}
function runPrompt() {
  const reader = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    prompt: 'Lox> ',
  });
  reader.prompt();
  const env = new Environment(null);
  reader
    .on('line', (line) => {
      new Lox().run(line, env);
      defaultErrorHandler.reset();
      reader.prompt();
    })
    .on('close', () => {
      console.log('end Lox!');
      process.exit(0);
    });
}
init();
